<div class="agenda-wrapper">
  <div>
    <p>Start time: <span id="start-time"></span></p>
    <p>End time: <span id="end-time"></span></p>
    <p>Employee: <span id="employee-name"></span></p>
    <div class="container postes-list">
      <div class="row">
        <% @postes.each do |poste| %>
          <div class="col-xs-6 col-sm-1">
            <div class="poste resizable grab flex-center" style="background-color: <%= COLORS.sample %>"><%= poste %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div id="agenda">
    <table id="planner">
      <tr>
        <th>Employees</th>
        <% @range.each do |time| %>
          <th colspan="2"><%= time %>h</th>
        <% end %>
      </tr>
      <% @employees.each do |employee| %>
        <tr>
          <td class="text-right name-padding-right"><%= employee %></td>
          <% @range.each do |time| %>
            <td class="time-cell" id="<%= "#{time}/#{employee}" %>"><div class="blech"></div></td>
            <td class= "time-cell" id="<%= "#{time}.5/#{employee}" %>"><div class="blech"></div></td>
          <% end %>
        </tr>
      <% end %>
    </table>
    <div id="bin">
      <i class="fa fa-trash"></i>
    </div>
    <div id="bin-wrapper"></div>
  </div>
</div>

<% content_for :scripts do %>
  <script>
    // POPOVER DELETE
    $("body").on('click', '[data-effect="delete"]', function(e){
    e.preventDefault();
    $(this).parent().parent().parent().find(".item").remove()
    $(this).parent().parent().remove()
    });


    $(function() {
      var uniqueIdForItems = 0
      var cellsDroppedIn = [];

      // POSTE DRAG

      $(".poste").draggable({
        cursor: "grabbing",
        helper: "clone",
        snap: ".time-cell",
        snapMode: "inner",
        revert: "invalid",
        start: function(e, ui) {
          $(ui.helper).removeClass("grab")
          $(ui.helper).addClass("dragged-poste")
          cellsDroppedIn = []
        },
      });

      // DROP

      $(".blech").droppable({
        tolerance: "touch",
        drop: function( event, ui ) {
          cellsDroppedIn.push(parseFloat($(this).parent().attr("id")))
          if (cellsDroppedIn.length === 1) {
            if ($(ui.draggable).hasClass("item") === false) {
              $(this).parent().append($(ui.draggable).clone().addClass("item i-" + uniqueIdForItems).attr('data-toggle', 'popover').attr('data-placement', 'bottom'));
              $('[data-toggle="popover"]').popover({
                html: true,
                content: "<a href='#' data-effect='delete'>delete</a>"
              });
            }
            $(".item").removeClass("ui-draggable product");
            $('.i-' + uniqueIdForItems).find('.ui-resizable-handle').remove();

            // ITEM DRAG

            $(".item").draggable({
              snap: ".time-cell",
              scroll: false,
              revert: "invalid",
              start: function(e, ui) {
                  cellsDroppedIn = []
              },
            });

            // ITEM RESIZE

            $(".item").resizable({
              grid: 30,
              stop: function(e, ui) {
                  var endTime = parseFloat($('#end-time').text())
                  blechbefore = ui.originalSize
                  blechafter = ui.size
                  endTime += ((blechafter['width'] - blechbefore['width']) / 30 / 2)
                  if (endTime > 23.5) {
                    endTime -= 24
                  }
                  $("#end-time").text(endTime)
              }
            });
            uniqueIdForItems += 1
          }
          var endTime = cellsDroppedIn[cellsDroppedIn.length - 1] + 0.5
          var startTime = cellsDroppedIn[0]
          var employeeName = $(this).parent().attr("id").match(/\/(.*)$/)[1];
          $('#start-time').text(startTime)
          $('#end-time').text(endTime)
          $('#employee-name').text(employeeName)
        }
      });

      // BIN

      $("#bin").droppable({
        tolerance: "touch",
        accept: '.item',
        drop: function(event, ui) {
          $(ui.draggable).remove();
        }
      });

      // RESIZE

      $(".resizable").resizable({
        grid: 30,
        stop: function(e, ui) {
            var endTime = parseFloat($('#end-time').text())
            blechbefore = ui.originalSize
            blechafter = ui.size
            endTime += ((blechafter['width'] - blechbefore['width']) / 30 / 2)
            if (endTime > 23.5) {
              endTime -= 24
            }
            $("#end-time").text(endTime)
        }
      });
    });
  </script>
<% end %>
