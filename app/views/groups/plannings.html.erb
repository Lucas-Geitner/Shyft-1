<h1><%= "#{@organisation.group_name.capitalize}: #{@group.name}" %></h1>

<h2>
  <%= link_to group_plannings_path(@group, date: (@today - 1.day).strftime("%F")), class: "text-center caret-button" do %>
    <i class="fa fa-caret-left"></i>
  <% end %>
  <%= @today.strftime("%b %d, %Y") %>
  <%= link_to group_plannings_path(@group, date: (@today + 1.day).strftime("%F")), class: "text-center caret-button" do %>
    <i class="fa fa-caret-right"></i>
  <% end %>
</h2>

<div class="planning-header">
  <form action="/groups/<%= @group.id %>/plannings" class="search-container form-inline">
    <input name="date" class="datepicker form-control input-lg" placeholder="<%= params[:date].present? ? params[:date] : "12/11/2016" %>">
    <input type="submit" class="btn btn-lg" value="Rechercher" style ="font-size: 15px">
  </form>
</div>

<% @group.shops.each do |shop| %>
  <% if shop.closing_time.hour < shop.opening_time.hour
      range = (shop.opening_time.hour..23).to_a
      (0..shop.closing_time.hour).to_a.each { |t| range << t }
    else
      range = (shop.opening_time.hour..shop.closing_time.hour).to_a
    end %>
  <h2><%= @organisation.shop_name %>: <%= shop.name %></h2>
  <div id="agenda">
    <div class="employee-names">
      <ul class="list-unstyled text-right">
        <% memberships = Membership.where(shop: shop, archived_at: nil) %>
        <% employees = [] %>
        <% memberships.each { |m| employees << m.user } %>
        <% employees.each do |employee| %>
          <%= link_to user_path(employee) do %>
            <li>
              <div class="user-details-icon">
                <%= employee.first_name[0] + employee.last_name[0] %>
              </div>
              <div>
                <%= employee.first_name %>
              </div>
            </li>
          <% end %>
        <% end %>
      </ul>
    </div>
    <div style="position: relative;">
      <div class="time-headers">
        <% range.each do |time| %>
          <div class="time-header"><%= time %>:00</div>
        <% end %>
      </div>
      <table id="planner">
        <tr>
          <% range[0...-1].each do |time| %>
            <th colspan="4"></td>
          <% end %>
        </tr>
        <% employees.each do |employee| %>
          <tr>
            <% range[0...-1].each do |time| %>
              <td class="time-cell" id="<%= "#{time}/#{employee.id}" %>"><div class="blech"></div></td>
              <td class="time-cell" id="<%= "#{time}.25/#{employee.id}" %>" style="border-left: 1px dotted rgba(57,70,76,0.1)"><div class="blech"></div></td>
              <td class= "time-cell" id="<%= "#{time}.5/#{employee.id}" %>" style="border-left: 1px dotted rgba(37,50,56,0.3)"><div class="blech"></div></td>
              <td class= "time-cell" id="<%= "#{time}.75/#{employee.id}" %>" style="border-left: 1px dotted rgba(57,70,76,0.1)"><div class="blech"></div></td>
            <% end %>
          </tr>
        <% end %>
      </table>
    </div>
  </div>
<% end %>

<% content_for :scripts do %>
  <script>
    $(function() {
      <% @group.shops.each do |shop| %>
        <% shifts = [] %>
        <% shop.plannings.each do |p| %>
          <% Shift.where("planning_id = :planning AND starts_at >= :today AND ends_at < :tomorrow", { planning: p.id, shop: shop.id, today: @today, tomorrow: @tomorrow }).each do |shift| %>
            <% shifts << shift %>
          <% end %>
        <% end %>
        <% shifts.each do |shift| %>
          <% shop_poste = ShopPoste.where(shop: shop, poste: shift.poste).first %>
          <% div_width = (shift.ends_at - shift.starts_at) / 60 %>
            <% if shift.starts_at.min == 30
              minutes = "\\\\.5"
            elsif shift.starts_at.min == 15
              minutes = "\\\\.25"
            elsif shift.starts_at.min == 45
              minutes = "\\\\.75"
            else
              minutes = ""
            end %>
            $("#<%= "#{shift.starts_at.hour}#{ minutes }\\\\/#{shift.user_id}" %>").append('<div class="poste resizable grab item flex-center" style="background-color: <%= shop_poste.present? ? shop_poste.color : "#D2D2D2" %>; width: <%= div_width %>px"><%= shift.poste.name %></div>')
            $('#<%= shift.user.id %>dh').text(parseFloat($('#<%= shift.user.id %>dh').text()) - <%= div_width / 60 %>)
            if ( parseFloat($('#<%= shift.user.id %>dh').text()) <= 0 ) {
              $('#<%= shift.user.id %>dh').addClass("over-hours")
            } else {
              $('#<%= shift.user.id %>dh').removeClass("over-hours")
            }
        <% end %>
      <% end %>
    });
  </script>
<% end %>
